# 資産管理デフォルト設定機能 - 使い方ガイド

## 概要

資産管理機能に、次月のデータを自動生成する際のデフォルト設定機能が追加されました。
毎月同じ情報を入力する手間を省き、効率的に資産管理ができます。

---

## 3つのデフォルト設定

### ① 固定収入設定
毎月定期的に得られる収入（給与、副業など）を事前に設定できます。

**設定内容：**
- 収入源の名前（例：給与、副業）
- 金額

**活用例：**
- 給与: ¥300,000
- 副業: ¥50,000
- 合計: ¥350,000

### ② デフォルトクレジットカード設定
毎月決まって使用するクレジットカードの支出を事前に設定できます。

**設定内容：**
- カード名（例：楽天カード、ANAカード）
- 予想支出額

**活用例：**
- 楽天カード（生活費）: ¥80,000
- ANAカード（固定費）: ¥70,000
- 合計: ¥150,000

### ③ NISA月次積立額
NISA口座への月次積立額を表示・管理できます。

**仕組み：**
- NISA口座管理画面で設定した `monthly_contribution`（月次積立額）を自動集計
- デフォルト設定画面では合計額の表示のみ
- 個別の積立額変更はNISA口座管理画面から行う

**活用例：**
- 楽天証券NISA: ¥30,000/月
- SBI証券NISA: ¥20,000/月
- 合計積立額: ¥50,000/月

---

## 設定方法

### 1. 設定画面へのアクセス

1. 資産管理画面（`/assets`）を開く
2. 右上の **歯車アイコン** をタップ
3. 「デフォルト設定」画面が表示される

### 2. 固定収入を設定する

1. 「固定収入設定」セクションを確認
2. 「＋ 収入を追加」ボタンをタップ
3. 入力フィールドが追加される
   - 収入源名を入力（例：給与）
   - 金額を入力（例：300000）
4. 複数の収入源がある場合は繰り返す
5. 不要な項目は右側の「×」ボタンで削除
6. 画面下部の「保存」ボタンをタップ

### 3. デフォルトクレジットカードを設定する

1. 「デフォルトクレジットカード設定」セクションを確認
2. 「＋ カードを追加」ボタンをタップ
3. 入力フィールドが追加される
   - カード名を入力（例：楽天カード）
   - 予想支出額を入力（例：80000）
4. 複数のカードがある場合は繰り返す
5. 不要な項目は右側の「×」ボタンで削除
6. 画面下部の「保存」ボタンをタップ

### 4. NISA月次積立額を確認する

1. 「NISA月次積立設定」セクションを確認
2. 現在の合計積立額が表示される
3. 個別の積立額を変更したい場合：
   - 「NISA管理画面で設定」リンクをタップ
   - `/assets/nisa` 画面で各口座の `monthly_contribution` を編集

---

## 動作の仕組み

### デフォルト設定が反映されるタイミング

**次月データ生成時のみ**反映されます。

#### 具体的な流れ：

1. **現在：2026年1月**の資産データを入力・確認
2. 資産管理画面で **「次月へ」** ボタンをタップ
3. **2026年2月のデータがまだ存在しない**場合：
   - システムが自動的に2月のデータを生成
   - その時点で設定されているデフォルト設定を取得
   - 2月のデータに反映して保存

4. **生成された2月のデータ：**
   ```
   【口座残高】
   1月の給料日時点の計算残高を引き継ぎ

   【収入】
   月次収入合計: ¥350,000
   詳細:
   - 給与: ¥300,000
   - 副業: ¥50,000

   【クレジットカード】
   支出合計: ¥150,000
   詳細:
   - 楽天カード: ¥80,000
   - ANAカード: ¥70,000

   【NISA評価額】
   1月の評価額 + 月次積立額（¥50,000）
   ```

5. 生成された2月のデータは **独立したデータ** になる
   - 後からデフォルト設定を変更しても2月には影響しない
   - 2月のデータは個別に編集可能

### 重要なポイント

✅ **次月生成時にスナップショット** として設定が反映される
✅ **一度生成された月のデータは独立** しており、後から自由に編集できる
✅ **デフォルト設定の変更は、これから生成する未来の月** に影響する

❌ デフォルト設定を変更しても、既に生成済みの月には影響しない
❌ 過去の月には遡って反映されない

---

## データの保存場所

各設定は以下の場所に保存されます：

| 設定項目 | 保存先 |
|---------|--------|
| 固定収入 | `income_records` テーブル（frequency='monthly'） |
| デフォルトクレジットカード | `users.default_credit_cards`（JSONB列） |
| NISA月次積立額 | `nisa_accounts.monthly_contribution` |

---

## 実際の使用例

### シナリオ：毎月の収入・支出パターンが決まっている場合

**前提条件：**
- 毎月の給与: ¥300,000
- 毎月の副業収入: ¥50,000
- 楽天カード（生活費）: 約¥80,000
- ANAカード（固定費）: 約¥70,000
- NISA積立: ¥50,000

**初期設定（1回のみ）：**

1. デフォルト設定画面で固定収入を設定
   - 給与: ¥300,000
   - 副業: ¥50,000

2. デフォルトクレジットカードを設定
   - 楽天カード: ¥80,000
   - ANAカード: ¥70,000

3. NISA口座管理画面で月次積立額を設定
   - 楽天証券NISA: monthly_contribution = ¥50,000

4. 「保存」をタップ

**毎月の運用：**

1. **1月のデータ入力：**
   - 実際の口座残高を確認・入力
   - 実際の収入・支出を確認（デフォルトから大きく変わっていれば調整）
   - 実際のNISA評価額を入力
   - 「確定」ボタンをタップ

2. **2月へ移動：**
   - 「次月へ」ボタンをタップ
   - 自動的に2月のデータが生成される
   - デフォルト設定が反映された状態で表示される
   - 実際の値と異なる場合は編集

3. **3月以降も同様：**
   - 毎月「確定」→「次月へ」の流れ
   - デフォルト設定が反映されるので入力の手間が大幅に削減

**デフォルト設定を変更する場合：**

例：4月から副業収入が増える（¥50,000 → ¥80,000）

1. デフォルト設定画面で副業収入を¥80,000に変更
2. 「保存」をタップ
3. **3月までのデータは変わらない**
4. **4月以降の新規生成データに反映**される

---

## データベース移行手順

この機能を使用する前に、Supabaseで以下のSQLを実行してください。

```sql
ALTER TABLE users
ADD COLUMN IF NOT EXISTS default_credit_cards JSONB DEFAULT '[]'::jsonb;

COMMENT ON COLUMN users.default_credit_cards IS 'デフォルトクレジットカード設定（JSON配列）';
```

**実行方法：**

1. Supabase Dashboard にログイン
2. 左メニューから「SQL Editor」を選択
3. 上記のSQLをコピー＆ペースト
4. 「Run」ボタンをクリック
5. 成功メッセージが表示されればOK

※ `phase5-asset-management-v2-defaults.sql` ファイルにも同じSQLが保存されています。

---

## よくある質問

### Q1: デフォルト設定を途中で変更したらどうなる？

**A:** 変更後に生成する未来の月のデータに反映されます。既に生成済みの月のデータは変わりません。

例：
- 1月に設定したデフォルト → 2月生成時に反映
- 2月にデフォルト設定を変更 → 3月生成時に新しい設定が反映
- 2月のデータは変わらない（個別に編集可能）

### Q2: デフォルト設定と実際の値が違う月はどうする？

**A:** 生成された月のデータを個別に編集してください。

例：
- デフォルト給与: ¥300,000
- 実際の給与（賞与月）: ¥500,000
- → 生成された月のデータで「収入詳細を編集」から¥500,000に変更

### Q3: 過去の月に遡ってデフォルト設定を適用できる？

**A:** できません。デフォルト設定は次月生成時のみ反映されます。過去の月を変更したい場合は個別に編集してください。

### Q4: 収入やカードを削除したい場合は？

**A:** デフォルト設定画面で該当項目の「×」ボタンをタップして「保存」してください。次回以降の生成データには反映されなくなります。

### Q5: NISA積立額だけ変更したい場合は？

**A:** デフォルト設定画面の「NISA管理画面で設定」リンクから `/assets/nisa` に移動し、各NISA口座の `monthly_contribution` を編集してください。

### Q6: 確定したデータを後から編集できる？

**A:** できます。確定済みのデータも編集可能です。ただし、確定を解除することはできません（確定状態は保持されます）。

---

## トラブルシューティング

### 問題: 次月データが生成されない

**原因:**
- データベース移行が完了していない
- ユーザー認証エラー

**解決方法:**
1. データベース移行SQLを実行したか確認
2. 一度ログアウトして再ログイン
3. ブラウザのキャッシュをクリア

### 問題: デフォルト設定が保存されない

**原因:**
- ネットワークエラー
- 入力値が不正（空欄、負の数など）

**解決方法:**
1. すべてのフィールドに有効な値を入力
2. 金額は正の数値を入力
3. ネットワーク接続を確認して再試行

### 問題: NISA積立額が表示されない

**原因:**
- NISA口座が登録されていない
- `monthly_contribution` が設定されていない

**解決方法:**
1. `/assets/nisa` でNISA口座を登録
2. 各口座の `monthly_contribution` に金額を設定
3. デフォルト設定画面に戻って確認

---

## まとめ

デフォルト設定機能により、毎月の資産管理がより効率的になります。

**設定は1回、効果はずっと：**
- 初回にデフォルト設定を行う
- 毎月の入力時間を大幅削減
- 必要に応じて個別に調整可能

**柔軟な運用が可能：**
- デフォルト設定はいつでも変更可能
- 各月のデータは独立して編集可能
- 過去データへの影響なし

資産管理を効率化して、より重要な財務分析に時間を使いましょう！
